# 数据采集服务

## Overview

`AcqServer`(`acquisition server`)的功能是把最新的采集数据更新至`SCADA`数据库中，并通过事件报文进行`SCADA`层面的变化数据广播。
`AcqServer`对性能要求高，对延时比较敏感，<format style="bold" color="Red">除了程序必需的缓存外(缓存只允许在init函数和析构函数中进行内存管理)，业务代码里原则上不允许出现动态分配内存</format>，即：

- 不允许使用`new`/`delete`；
- 不允许使用`vector`、`list`、`map`等需要动态管理内存的容器；

`AcqServer`的主要功能是将最新的采集数据写入数据库中、同步至系统内所有的`SCADA`节点，并在消息总线上发布相应的事件报文，其数据流如下图所示：

![AcqServer数据流](acqserver_main.png)

## 主备机制

值班/备用指的是各个节点的`SCADA`应用在系统中的运行状态。`AcqServer`程序可以利用平台对应用的自动管理机制，来实现程序的高可靠、高性能需求。
`AcqServer`的值班/备用设计有两种思路：

### 热备模式

在这种模式下只有值班节点的`AcqServer`会进行所有任务的处理，备机只处理变化/全量数据(状态量/SOE)以生成`updateDataQueue`。
值班机在数据处理完毕后会发送事件报文，备用机通过订阅该事件报文用于判断`updateDataQueue`中哪些数据已完成更新并从缓存队列中删除相应的对象，
这样备用机的`updateDataQueue`中保留的就是值班机尚未处理的数据。

在值班/备用发生切换后，值班机应立即清空事件报文缓存队列，转为备用机运行模式，备用机应开始处理`updateDataQueue`中剩余的数据。

通过以上方式可以保证值班/备用发生切换时，状态量/SOE变化报文在SCADA应用层不丢不多。

### 负载均衡模式

热备模式架构简单，但缺点是值班机承担了绝大部分的网络负载(变化数据报文、事件报文)，如果这部分性能存在瓶颈则需要考虑进行`SCADA`节点之间的负载均衡。
在负载均衡模式下，值班机将承担`IED`值班状态的动态分配、管理，该值班状态会随着各`SCADA`节点的`AcqServer`运行情况变化而变化。该任务的流程图如下：

<img height="300" src="acqserver_lb.png" width="500"/>

`AcqServer`需要处理`IED`分配更新事件报文，与装库事件处理类似，在收到该事件报文后启动restart流程。
在负载均衡模式下，部分缓存队列需要开设两份(值班/备用)，相应的处理代码也需要进行适配，在restart时也需要进行相关的处理，值班队列与备用队列里的部分数据可能会需要进行迁移互换。

## 程序缓存

建立缓存的过程在`init`函数中实现，在`server`启动或`restart`的时候会调用。主要分为采集数据缓存和采集模型缓存。

### 采集数据缓存

`AcqServer`的业务链条涉及到3个缓存队列，`AcqServer`的业务特点决定了这几个缓存队列读写频繁且涉及到多线程同步。考虑到这些因素，`AcqServer`使用了固定大小的`spsc_queue`(单生产单消费无锁队列)来放置缓存，其特点是：
- 不论生产还是消费均不用加锁，写代码较为方便，执行性能也高；
- 队列为固定大小，使用过程中不会进行动态内存分配，使用效率高；
- 要求消费速率大于生产速率，否则会出现队列塞满，数据丢失的现象；

### 采集模型缓存

`AcqServer`里经常会搜索FE、`SCADA`两边数据模型的映射关系。为了提高`AcqServer`的运行效率，需要把`FE`和`SCADA`的数据模型缓存下来，
综合考虑搜索效率和传输报文大小，可在`FE`变化报文中传输测点所属`IED`的`oid`信息，这样构建`IED`->测点两级数据模型进行缓存：

- 测点模型使用`hashmap`来保存（使用`Boost`提供的`unordered_flat_map`，遍历/查询性能均优于`std`提供的`unordered_map`）；
- key是`FE`的`IED`的`oid`；
- value是`std::pair`形式，保存该`IED`下`FE`测点的`visitor`(网络方式)，以及对应`SCADA`测点的`visitor`(本地方式)；
> 这里是裁剪过的`FE`测点，只保留必需的属性；
> 
> 使用`visitor`的`sync`接口来更新`FE`测点的`value/quality/updatetime`，不用重新申请内存；
> 
> `SCADA`测点`visitor`是本地方式打开数据库，无需更新。
- 同一个`pair`里的两个`visitor`对象里的元素是一一对应的，方便按照下标进行数据比较；
- `visitor`根据`FE`测点的`oid`建立`hash`索引；
> 这样在处理变化报文时就可以根据`IED`的`oid`、测点的`oid`的两级`hashmap`快速定位到相应的`SCADA`测点对象；
> 
> 定位的时间复杂度是O(1)。

> 量测模型建立时保证了每个IED下的SCADA测点与FE测点是一一对应的，个数和顺序均保持一致；
>
{style="warning"}

## 事件回调

`AcqServer`需要处理的事件包括：
- 装库事件；
- 配置文件变化事件；
- 负载均衡变化事件；
- 变化遥信/遥测/遥脉事件；
- SOE事件；

前三类事件通过实现`TaskServer`的相关虚函数来处理，后两类事件需要在回调里更新feEventQueue，然后唤醒相应的周期任务进行处理(activate方式)。

## 主要任务说明

### 处理变化数据

本任务的目的是处理缓存队列中的变化数据，将本机需要处理的数据写入本机实时数据库。
本任务的启动方式有两种：
- 按照固定时间间隔循环启动;
- 被其他任务唤起(缓存队列的生产任务);

任务启动后的内部概要流程图如下：

<img height="300" src="acqserver_task1.png" width="500"/>

正常情况下，队列一旦有数据插入就将以触发方式启动本任务。循环执行只是为了保险起见，可以将循环间隔设置为一个较长的定值，以减少不必要的CPU消耗。

### 处理全量数据

本任务的目的是保证`SCADA`数据与`FE`量测数据的一致性，`AcqServer`启动时必须立即执行。
本任务的启动方式为循环启动，时间间隔可设置长一些，第一次执行是必要的，后续执行只是为了保险起见。
全量数据的处理流程与变化数据类似，只是数据来源不是队列，而是直接访问数据库(网络方式)。但为了保证数据处理正确性，在访问前置数据库获取最新数据之前，需要先清空变化队列中的缓存。完整流程如下图所示：

<img height="300" src="acqserver_task2.png" width="500"/>

### 处理数据库同步

本任务的目的是将本机处理的变化数据同步至其他SCADA节点，保证所有节点的数据库一致性。
本任务需要平衡以下两点基本需求：
- 业务要求变化数据处理越快越好；
- 平台消息总线要求尽量把报文打包发送；
总体的处理原则是变化数据缓存不立即处理，而是等待其积攒到一定数量：
- 为了尽量避免发送大量小体积的报文，可对单次处理的变化数据数量设置最小数目限值。
- 为了不影响变化数据的传输速率性能，设置变化数据的最长等待时限；

本任务的流程图如下所示：

<img height="300" src="acqserver_task3.png" width="500"/>

### 发送事件报文

本任务是通知其他`SCADA`程序有变化遥信、遥测，方便其实现各自的业务功能，例如发送遥信告警、启动公式计算等等。
本任务的流程图与处理数据库同步的流程图类似，在此不再赘述。